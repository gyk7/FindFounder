<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<meta name="description" content="" />
	<meta name="author" content="" />
	<title>커뮤니티</title>
	<link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
	<link href="css/styles.css" rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Yeon+Sung&display=swap" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
	<script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

	<style>
		ul,
		li {
			list-style: none;
		}

		.card {
			padding: 10px;
			/* 원하는 패딩 값으로 조절합니다. */
			max-height: 520px;
			/* 원하는 최대 높이 값을 지정합니다. */
			overflow: hidden;

		}

		.card-header .fas {
			font-size: 24px;
			/* 아이콘의 크기를 조절합니다. */

		}

		.card-header {
			font-family: "Yeon Sung", system-ui;
			font-size: 24px;
			/* 텍스트의 크기를 조절합니다. */
		}

		#board-search1 {
			position: absolute;
			top: 80px;
			/* 원하는 위쪽 여백을 설정합니다. */
			right: 20px;
			/* 오른쪽으로 이동합니다. */
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 50px;
		}

		table th {
			padding: 14px 21px;
			background: rgb(227, 241, 255);
			/* 
                #efefef
                #eeeeee
                #ececec
                #cccccc
                #dddddd
                #333333
                #666666
                #999999
             */
			color: #666;
			font-size: 12px;
			border-top: 2px solid #333;
			border-bottom: 2px solid #ddd;
		}

		table td {
			padding: 14px 21px;
			color: #666;
			font-size: 12px;
			border-bottom: 1px solid #ddd;
			text-align: center;
		}

		table tr:hover {
			background: #eee;
			cursor: pointer;
		}

		.subject {
			width: 45%;
			text-align: left;
		}

		.paging {
			padding: 20px 0;
			width: 100%;
			margin-top: 20px;
		}

		.paging>ul {
			display: flex;
			justify-content: center;
		}

		.paging>ul>li {
			padding: 8px;
			background: #efefef;
			border: 1px solid #999;
			font-size: 12px;
			margin-left: 10px;
		}

		.paging>ul>li:hover {
			cursor: pointer;
			background: #333;
			color: #fff;
		}

		.active {
			background: #333 !important;
			color: #fff;
		}

		.title {
			font-family: "Yeon Sung", system-ui;
			font-weight: 400;
			font-style: normal;
			font-size: 60px;
			margin-top: 18px;
		}


		.btn-primary {
			font-family: "Yeon Sung", system-ui;
			position: relative;
			
			/* 원하는 만큼 위쪽으로 이동합니다. */
		}

		.btn-dark {
			font-family: "Yeon Sung", system-ui;
			/* 변경하고 싶은 글꼴을 지정합니다. */
		}

		.resultTable th {
			border-bottom: 2px solid rgb(192, 192, 192);
			/* 변경하고 싶은 색상을 여기에 지정합니다. */
		}

		.resultTable td {
			/* 변경하고 싶은 색상을 여기에 지정합니다. */
			border-bottom: 1px solid rgb(192, 192, 192);
			/* 변경하고 싶은 색상을 여기에 지정합니다. */
		}
	</style>
</head>

<body>
	<div th:replace="nav.html :: navbar-top"></div>
	<div id="layoutSidenav">
		<div id="layoutSidenav_nav">
			<nav th:replace="nav.html :: navbar-side"></nav>
		</div>
		<div id="layoutSidenav_content">
			<main>
				<div class="container-fluid px-4">
					<div class="title">
						커뮤니티
					</div>

					<div class="card mb-4">
						<div class="card-header">
							<i class="fas fa-table me-1"></i>
							서울상권 커뮤니티

						</div>

						<div class="card-body">
							<table class="resultTable">
								<caption> 커뮤니티 </caption>

							</table>
							<div id="board-search1">
								<div class="container">
									<div class="search-window">
										<form id="searchForm">
											<div class="search-wrap">
												<input id="searchInput" placeholder="검색어를 입력해주세요." value=""
													style="width: 300px;">
												<button type="submit" class="btn btn-dark">검색</button>

											</div>
										</form>
									</div>
								</div>
							</div>
							<div class="paging">
								<ul>
									<li><a href="#"><i class="fas fa-chevron-left"></i></a></li>
									<li class="active"><a href="/post-list?page=1">1</a></li>									
									<li><a href="/post-list?page=2">2</a></li>
									<li><a href="/post-list?page=3">3</a></li>
									<li><a href="/post-list?page=4">4</a></li>
									<li><a href="/post-list?page=5">5</a></li>
									<li><a href="#"><i class="fas fa-chevron-right"></i></a></li>
								</ul>
							</div>
							<button type="button" class="btn btn-primary float-end"
								onclick="location.href='/post-create'">글 작성</button>

						</div>
					</div>

				</div>

			</main>
			<footer th:replace="nav.html :: footer"></footer>
		</div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
		crossorigin="anonymous"></script>
	<script src="js/scripts.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"
		crossorigin="anonymous"></script>
	//
	<script src="js/datatables-simple-demo.js"></script>

</body>
<script>
	// 클라이언트에서 JWT 쿠키를 가져와서 HTTP 요청 헤더에 포함시키는 예제
	var url = '/api/board' + window.location.search;
	console.log(url)
	$(document).ready(

		function () {
			$.ajax({
				type: 'GET',
				url: url, // 로그인 엔드포인트 URL
				contentType: 'application/json',

				success: function (response) {
					// JWT 쿠키 가져오기
					let result = `
                    	 
                        <tr style="text-align: center">
                            <th>No</th>
                            <th>제목</th>
                            <th>조회수</th>
                            <th>좋아요수</th>
                            <th>작성자</th>
                            <th>작성일자</th>
                        </tr>
                  
                    
                    <tbody >`;



					console.log('게시글 전체 성공:', response);
					console.log(response.posts);
					const posts = response.posts.content;
					posts.forEach((post, index) => {
						console.log(post)

						result += `<tr data-id="${post.postId}" class="clickable-row">
                    				<td>    ${index + 1} </td>    
									<td>    ${post.postTitle} </td>    
									<td>    ${post.postViews} </td>    
									<td>    ${post.postLike} </td>    
									<td>    ${post.writer} </td>
									<td>    ${post.postDate} </td>    
                    				</tr>`;

					});
					result += "</tbody>"

					document.querySelector('.resultTable').innerHTML = result;
					// 행 클릭 이벤트 추가
					$('.clickable-row').on('click', function () {
						var postId = $(this).data('id');
						console.log(postId)
						window.location.href = '/post-details?postid=' + postId;

					});
					updatePagination(response.posts.pageable.pageNumber);
				},
				error: function (xhr, status, error) {
					console.error('게시글 전체 실패:', error, status, xhr);


				}
			});
			function updatePagination(activePage) {
				const pagination = document.querySelector('.paging ul');
				let pages = pagination.querySelectorAll('li a');
				pages.forEach(page => {
					if (page.textContent == activePage + 1) {
						page.parentNode.classList.add('active');
					} else {
						page.parentNode.classList.remove('active');
					}
				});
			}
		});


</script>
<script>
	$(document).ready(function () {
		// 검색 폼 이벤트 리스너 추가
		$('#searchForm').on('submit', function (e) {
			e.preventDefault(); // 기본 이벤트 차단
			const keyword = $('#searchInput').val(); // 검색어 가져오기
			searchPosts(keyword); // 검색 실행 함수 호출
		});

		function searchPosts(keyword) {
			console.log("검색서비스 테스트" + window.location.search)
			var searchUrl = ""
			if (!window.location.search) {


				console.log("널널널" + searchUrl);
			}
			searchUrl = "/api/board/search?" + "keyword=" + keyword;

			$.ajax({
				type: 'GET',
				url: searchUrl,
				contentType: 'application/json',
				success: function (response) {
					let result = `
                    <tr style="text-align: center">
                        <th>No</th>
                        <th>제목</th>
                        <th>조회수</th>
                        <th>좋아요수</th>
                        <th>작성자</th>
                        <th>작성일자</th>
                    </tr>
                    <tbody>`;
					const posts = response.posts.content; // 응답 구조에 따라 경로 수정 필요
					posts.forEach((post, index) => {
						result += `<tr data-id="${post.postId}" class="clickable-row">
                                    <td>${index + 1}</td>
                                    <td>${post.postTitle}</td>
                                    <td>${post.postViews}</td>
                                    <td>${post.postLike}</td>
                                    <td>${post.writer}</td>
                                    <td>${post.postDate}</td>
                               </tr>`;
					});
					result += "</tbody>";
					$('.resultTable').html(result);
					// 행 클릭 이벤트 다시 바인딩
					$('.clickable-row').on('click', function () {
						var postId = $(this).data('id');
						window.location.href = '/post-details?postid=' + postId;
					});
				},
				error: function (xhr, status, error) {
					console.error('검색 실패:', error);
					alert('검색 결과를 불러오는데 실패했습니다.');
				}
			});
		}
	});
</script>
<script>
	// 로그인, 로그아웃 추가
	// 로그인 상태를 확인하는 함수
	function isLoggedIn() {
		// 클라이언트의 모든 쿠키를 가져옵니다.
		console.log('###########');
		const cookies = document.cookie.split(';');

		// 쿠키에서 로그인 상태를 나타내는 특정 쿠키를 찾습니다.
		for (let i = 0; i < cookies.length; i++) {
			const cookie = cookies[i].trim();
			if (cookie.startsWith("Set-Cookie")) {
				console.log(cookie)
				return true; // 로그인 상태
			}
		}
		return false; // 로그아웃 상태
	}

	// 로그아웃 함수
	function logout() {
		// 로그아웃 요청을 보내고, 성공시에만 링크를 변경합니다.
		fetch('/api/user/logout', {
			method: 'POST'
		}).then(function (response) {
			if (response.ok) {
				document.getElementById('logout').style.display = 'none'; // 로그아웃 링크 숨김
				document.getElementById('login').style.display = 'block'; // 로그인 링크 표시
			}
		});
	}
	document.addEventListener('DOMContentLoaded', function () {
		try {
			// 오류가 발생할 수 있는 코드
			console.log("#########");

			// isLoggedIn() 함수 호출
			if (isLoggedIn()) {
				document.getElementById('logout').style.display = 'block';
				document.getElementById('login').style.display = 'none';
			} else {
				document.getElementById('logout').style.display = 'none';
				document.getElementById('login').style.display = 'block';
			}
		} catch (error) {
			// 오류 발생 시 처리
			console.error("An error occurred:", error);
		}

	});

</script>

</html>